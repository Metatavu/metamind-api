<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

  <changeSet author="Heikki Kurhinen" id="initial-database">
    <createTable tableName="Message">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="externalId" type="VARCHAR(191)">
        <constraints nullable="false" unique="true" uniqueConstraintName="UN_MESSAGE_EXTERNAL_ID"/>
      </column>
      <column name="content" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="response" type="LONGTEXT">
        <constraints nullable="true"/>
      </column>
      <column name="hint" type="VARCHAR(191)">
        <constraints nullable="true"/>
      </column>
      <column name="created" type="datetime(6)">
        <constraints nullable="false"/>
      </column>
      <column name="session_id" type="BIGINT">
          <constraints nullable="false"/>
      </column>
    </createTable>
    
    <createTable tableName="QuickResponse">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="option" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="message_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <createTable tableName="Session">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="externalId" type="VARCHAR(191)">
        <constraints nullable="false" unique="true" uniqueConstraintName="UN_SESSION_EXTERNAL_ID"/>
      </column>
      <column name="created" type="datetime(6)">
        <constraints nullable="false"/>
      </column>
      <column name="locale" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
      <column name="visitor" type="VARCHAR(191)">
        <constraints nullable="true"/>
      </column>
      <column name="data" type="LONGBLOB">
        <constraints nullable="true"/>
      </column>
    </createTable>
    
    
    <addForeignKeyConstraint baseTableName="Message" baseColumnNames="session_id" constraintName="FK_MESSAGE_SESSION_ID" referencedColumnNames="id" referencedTableName="Session"/>
    <addForeignKeyConstraint baseTableName="QuickResponse" baseColumnNames="message_id" constraintName="FK_QUICK_RESPONSE_MESSAGE_ID" referencedColumnNames="id" referencedTableName="Message"/>
  </changeSet>
  

  <changeSet author="Antti Leppa" id="session-timezone">
    <addColumn tableName="Session">
      <column name="timeZone" type="VARCHAR(191)">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>
  
  <changeSet id="rename-quick-response-option-to-quick-response-text" author="Heikki Kurhinen">
    <renameColumn tableName="QuickResponse" oldColumnName="option" newColumnName="quickResponseText" columnDataType="VARCHAR(191)"/>
  </changeSet>
  
  <changeSet id="system-settings" author="Heikki Kurhinen">
    <createTable tableName="SystemSetting">
      <column name="id" type="bigint(20)" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="settingKey" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
      <column name="value" type="longtext">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addUniqueConstraint constraintName="UN-SYSTEM-SETTING-SETTING-KEY" columnNames="settingKey" tableName="SystemSetting"/>
  </changeSet>
  
  <changeSet author="Antti Leppa" id="freemarker-template">
    <createTable tableName="FreemarkerTemplate">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false" unique="true" uniqueConstraintName="UN_FREEMARKER_TEMPLATE_NAME"/>
      </column>
      <column name="data" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="created" type="datetime(6)">
        <constraints nullable="false"/>
      </column>
      <column name="modified" type="datetime(6)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  
  <changeSet author="Antti Leppa" id="message-score">
    <addColumn tableName="Message">
      <column name="matchedIntent" type="VARCHAR(191)"/>
      <column name="responseScore" type="DOUBLE"/>
    </addColumn>
    
  </changeSet>
  
  <changeSet author="Antti Leppa" id="models">
    <createTable tableName="IntentModel">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false" unique="true" uniqueConstraintName="UN_INTENT_MODEL_NAME"/>
      </column>
      <column name="data" type="LONGBLOB">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createTable tableName="SlotModel">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false" unique="true" uniqueConstraintName="UN_SLOT_MODEL_NAME"/>
      </column>
      <column name="data" type="LONGBLOB">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  
  <changeSet author="Antti Leppa" id="story">
    <createTable tableName="Story">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="name" type="VARCHAR(191)">
        <constraints nullable="false" unique="true" uniqueConstraintName="UN_INTENT_MODEL_NAME"/>
      </column>
      <column name="storyJson" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
      <column name="configJson" type="LONGTEXT">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  
  <changeSet author="Antti Leppa" id="session-story">
    <sql>DELETE FROM QuickResponse</sql>
    <sql>DELETE FROM Message</sql>
    <sql>DELETE FROM Session</sql>
    
    <addColumn tableName="Session">
      <column name="story_id" type="BIGINT">
        <constraints foreignKeyName="FK_SESSION_STORY_ID" referencedColumnNames="id" referencedTableName="Story" />
      </column>
    </addColumn>
  </changeSet>
  
  <changeSet id="global-story-variable" author="Antti Leppa">
    <createTable tableName="StoryGlobalVariable">
      <column name="id" type="bigint(20)" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="story_id" type="BIGINT">
        <constraints foreignKeyName="FK_GLOBAL_STORY_VARIABLE_STORY_ID" referencedColumnNames="id" referencedTableName="Story" />
      </column>
      <column name="name" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
      <column name="value" type="longtext">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <addUniqueConstraint constraintName="UN_STORY_GLOBAL_VARIABLE_STORY_ID_NAME" columnNames="story_id,name" tableName="StoryGlobalVariable"/>
  </changeSet>
  
  <changeSet id="deprecated-settings" author="Antti Leppa">
    <delete tableName="SystemSetting">
      <where>settingKey in ("intent-model-url", "slot-model-url")</where>
    </delete>
  </changeSet>
  
  <changeSet id="client" author="Antti Leppa">
    <createTable tableName="Client">
      <column name="id" type="bigint(20)" autoIncrement="true">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="name" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
      <column name="clientId" type="varchar(191)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="clientSecret" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
      <column name="accessType" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="scripting-api-init" author="Heikki Kurhinen">
    <createTable tableName="script">
      <column autoIncrement="true" name="id" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="externalId" type="varchar(191)">
        <constraints nullable="false" unique="true" uniqueConstraintName="UN_SCRIPT_EXTERNAL_ID"/>
      </column>
      <column name="name" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
      <column name="language" type="varchar(191)">
        <constraints nullable="false"/>
      </column>
      <column name="content" type="longtext">
        <constraints nullable="false"/>
      </column>
    </createTable>
  
    <addUniqueConstraint constraintName="UN_SCRIPT_NAME_VERSION" columnNames="name,version" tableName="script"/>
  </changeSet>
  
</databaseChangeLog>
